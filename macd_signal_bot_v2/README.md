# MACD 多周期共振监控系统 V2

## 核心特性

✅ **使用已收盘K线** - 数据稳定可靠，避免实时波动  
✅ **智能轮询策略** - 在3分钟K线收盘后检测，效率更高  
✅ **1h反转触发** - 只在1h级别反转时启动检查  
✅ **多周期共振** - 15m/5m/3m必须同向才发送信号  
✅ **调试模式** - 详细日志帮助分析和验证  

## 快速开始

### 1. 正常运行

```bash
cd /Users/wang/PythonProjects/coin-cta/macd_signal_bot_v2
source /Users/wang/PythonProjects/.venv/bin/activate
python macd_signal_bot_v2.py
```

### 2. 调试模式（推荐首次运行）

```bash
# 方法1：使用调试脚本
./run_debug.sh

# 方法2：手动设置环境变量
export MACD_DEBUG=true
python macd_signal_bot_v2.py
```

## 核心改进说明

### 问题：为什么不用实时K线？

**场景重现**：
```
时间: 15:16:45
检测: GRASS/USDT
1h K线: 15:00-16:00 (还在形成中)
3m K线: 15:15-15:18 (还在形成中)
结果: 3m hist = 0.000422, Δ = 0.000034 (向上) ✅

时间: 15:30:02  
检测: GRASS/USDT
1h K线: 15:00-16:00 (同一根，还在形成中)
3m K线: 15:27-15:30 (还在形成中)
结果: 3m hist = 0.000243, Δ = -0.000019 (向下) ❌
```

**问题**：同一根1h K线，在不同时刻检测结果不一致！

### 解决方案：使用已收盘K线

```python
# 修改前：使用实时K线
current_hist = df.iloc[-1]["macd_hist"]  # 最后一根，正在形成
prev_hist = df.iloc[-2]["macd_hist"]

# 修改后：使用已收盘K线  
current_hist = df.iloc[-2]["macd_hist"]  # 倒数第2根，已收盘
prev_hist = df.iloc[-3]["macd_hist"]     # 倒数第3根，已收盘
```

**优势对比**：

| 特性 | 实时K线 | 已收盘K线 |
|------|---------|-----------|
| 数据稳定性 | ❌ 实时变化 | ✅ 固定不变 |
| 信号一致性 | ❌ 可能变化 | ✅ 始终一致 |
| 可验证性 | ❌ 难以对照 | ✅ 精确对应 |
| 延迟 | 0 | 30-40秒 |

## 智能轮询策略

### 轮询时间点

程序会在每个3分钟K线收盘后30秒检测：

```
K线收盘时间: 15:00, 15:03, 15:06, 15:09, 15:12, 15:15, ...
检测时间:     15:00:30, 15:03:30, 15:06:30, 15:09:30, ...
```

### 为什么加30秒缓冲？

1. K线在整点收盘（如 15:18:00）
2. 交易所需要时间处理和推送数据
3. 加30秒确保数据已完全更新
4. 避免获取到不完整的数据

### 示例

```
当前时间: 15:16:45
下一个3分钟整点: 15:18:00
等待到: 15:18:30 (收盘后30秒)
等待时长: 105秒
```

## 调试日志示例

启用调试模式后，您会看到详细的检测过程：

```
============================================================
🔍 开始检查 GRASS/USDT - 2025-11-26 15:30:02
============================================================

📊 检查1h反转:
  [1h] 当前K线(已收盘): 2025-11-26 14:00:00, hist=-0.00133477
  [1h] 前一K线(已收盘): 2025-11-26 13:00:00, hist=-0.00117416
  [1h] Δhist=0.00010275, 方向=向上
  [1h] 前二K线(已收盘): 2025-11-26 12:00:00, hist=-0.00120000
  [1h] 前一Δhist=-0.00016060 (向下)
  [1h] 当前方向=up, 前一方向=down
  ✅ [1h] 检测到向上反转！

🔍 检查共振周期（期望方向: up）:
  [15m] 当前K线(已收盘): 2025-11-26 15:15:00, hist=-0.00020600
  [15m] 前一K线(已收盘): 2025-11-26 15:00:00, hist=-0.00026500
  [15m] Δhist=0.00008943, 方向=向上
  ✅ [15m] 共振成功！方向=up
  
  [5m] 当前K线(已收盘): 2025-11-26 15:20:00, hist=0.00019699
  [5m] 前一K线(已收盘): 2025-11-26 15:15:00, hist=0.00016600
  [5m] Δhist=0.00003800, 方向=向上
  ✅ [5m] 共振成功！方向=up
  
  [3m] 当前K线(已收盘): 2025-11-26 15:24:00, hist=0.00026257
  [3m] 前一K线(已收盘): 2025-11-26 15:21:00, hist=0.00024352
  [3m] Δhist=0.00001906, 方向=向上
  ✅ [3m] 共振成功！方向=up

✅ 信号检测成功！方向: up
============================================================
```

## 检测逻辑

### 1h 反转检测

需要4根K线：`[-4, -3, -2, -1]`

```
使用 [-3] 和 [-2] 计算当前Δhist
使用 [-4] 和 [-3] 计算前一Δhist

向上反转：前一Δhist ≤ 0，当前Δhist > 0
向下反转：前一Δhist ≥ 0，当前Δhist < 0
```

### 共振检测（15m/5m/3m）

需要3根K线：`[-3, -2, -1]`

```
使用 [-3] 和 [-2] 计算Δhist

向上：Δhist > 0
向下：Δhist < 0

所有周期必须与1h方向一致
```

## 环境变量配置

```bash
# 企业微信 Webhook（可选）
export MACD_WECHAT_WEBHOOK_URL="https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=YOUR_KEY"

# 代理设置（可选）
export MACD_USE_PROXY=true
export MACD_PROXY_URL=http://127.0.0.1:7890

# 交易所（可选，默认binanceusdm）
export MACD_EXCHANGE=binanceusdm

# 调试模式（可选）
export MACD_DEBUG=true
```

## 测试工具

### 1. 测试时间计算

```bash
python test_timing.py
```

### 2. 测试单个交易对

```bash
python test_single_symbol.py
```

## 常见问题

### Q: 为什么信号有延迟？

A: 使用已收盘K线会有约30-40秒延迟：
- K线收盘时间：如15:15:00
- 程序检测时间：15:15:30（加30秒缓冲）
- 处理时间：约10秒
- 总延迟：约40秒

这是为了确保数据准确性的必要代价。对于趋势交易来说，40秒延迟完全可以接受。

### Q: 如何验证信号准确性？

A: 启用调试模式，查看详细的K线时间戳和hist值，对照图表上已收盘的K线进行验证。

### Q: 信号太少怎么办？

A: 这是正常的。系统要求1h反转+所有共振周期同向，条件严格，但信号质量高。

### Q: 可以改回实时K线吗？

A: 不推荐。实时K线会导致信号不稳定，误报率高。

## 更新日志

详见 [CHANGELOG.md](CHANGELOG.md)

## 技术支持

如有问题，请查看调试日志或联系开发者。

