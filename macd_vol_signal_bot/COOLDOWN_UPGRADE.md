# 🎯 冷却机制升级说明

## ✅ 升级完成！

按照你提供的需求说明，系统已完全升级为**基于 K 线数量的智能冷却机制**。

---

## 📊 核心改进

### 之前的问题 ❌

```yaml
signal:
  cooldown_minutes: 120  # 固定2小时
```

**问题**：
- 1h 周期：2小时 = 2根K线 ✅
- 15m 周期：2小时 = 8根K线 ❌ 太长
- 4h 周期：2小时 = 0.5根K线 ❌ 太短
- **不同周期下逻辑不一致！**

### 现在的方案 ✅

```yaml
signal:
  cooldown_bars: 2                      # 间隔 2 根 K 线
  break_cooldown_on_key_level: true     # 关键位可打破冷却
```

**优势**：
- 1h 周期：2根K线 = 2小时
- 15m 周期：2根K线 = 30分钟
- 4h 周期：2根K线 = 8小时
- **冷却时间自动随周期调整！**

---

## 🔧 技术实现

### 1. 升级的 DedupManager

#### 新增方法

**`is_in_cooldown()`** - 基于K线数量判断
```python
in_cooldown, bars_passed = dedup_mgr.is_in_cooldown(
    symbol, timeframe, direction, current_bar_time
)
# 返回: (是否在冷却期, 已经过去的K线数)
```

**`check_key_level_trigger()`** - 关键位事件检测
```python
event = dedup_mgr.check_key_level_trigger(
    symbol, timeframe, direction, 
    current_price, key_levels
)
# 返回关键位事件或None
```

**`_calculate_bars_between()`** - 计算K线间隔
```python
bars = self._calculate_bars_between(
    last_bar_time, current_bar_time, timeframe
)
# 自动处理不同周期：1m, 15m, 1h, 4h等
```

### 2. 关键位事件类型

#### SELL 信号
- ✅ 跌破支撑位 → 发送"关键位触达确认"
- ✅ 突破失效位 → 发送"信号失效提醒"

#### BUY 信号
- ✅ 突破阻力位 → 发送"关键位触达确认"
- ✅ 跌破失效位 → 发送"信号失效提醒"

### 3. 消息格式区分

#### 普通信号
```
【信号】BTCUSDT 1h — 🔴 做空信号
价格: 91000.00
置信度: 66%
风险等级: MID
建议: SELL
...
```

#### 关键位确认
```
🚨 关键位触达确认
BTCUSDT 1h — 🔴 SELL

价格已跌破关键支撑 89000.00
此前 SELL 观点得到进一步确认

当前价格: 88950.00
风险提示: 波动率较高，注意回撤
```

#### 信号失效
```
⚠️ 信号失效提醒
BTCUSDT 1h — 🔴 SELL

价格突破失效位 92500.00
此前 SELL 观点已失效

当前价格: 92600.00
风险提示: 波动率较高，注意回撤
```

---

## 🎯 业务逻辑流程

```
1. 检测到信号
   ↓
2. 检查是否在冷却期（基于K线数）
   ↓
   ├─ 不在冷却期 → 正常发送 → 记录K线时间戳
   │
   └─ 在冷却期 → 检查关键位事件
      ↓
      ├─ 无关键位事件 → 跳过发送
      │
      └─ 触发关键位 → 发送确认消息（打破冷却）
                       └─ 标记该关键位已触发（防重复）
```

---

## 📝 配置说明

### config.yaml 新配置

```yaml
signal:
  cooldown_bars: 2                      # 推荐值：1-3
  break_cooldown_on_key_level: true     # 是否启用关键位打破冷却
  max_valid_minutes: 240                # 状态清理用
```

**参数建议：**
- `cooldown_bars = 1`: 允许每根K线一个信号（激进）
- `cooldown_bars = 2`: 间隔1根K线（平衡） ⭐ 推荐
- `cooldown_bars = 3`: 间隔2根K线（保守）

---

## 🔒 安全约束（已实现）

✅ 同一关键位只能触发一次打破冷却
✅ 冷却期内不会重复发送普通信号
✅ 关键位提醒不会替代策略判断
✅ 关键位事件是"确认"而非"新信号"

---

## 📊 实际效果示例

### 场景 1: 正常冷却

```
10:00 - BTCUSDT 1h SELL 信号 @ 91000
       ✅ 发送信号
       
11:00 - 再次触发 SELL @ 90800
       ⏰ 冷却期内（经过1根K线），跳过
       
12:00 - 再次触发 SELL @ 90500
       ✅ 冷却结束（经过2根K线），发送信号
```

### 场景 2: 关键位打破冷却

```
10:00 - BTCUSDT 1h SELL 信号 @ 91000
       ✅ 发送信号（支撑位: 89000）
       
10:30 - 价格跌至 88950
       🚨 触发关键位（即使在冷却期）
       ✅ 发送"关键位触达确认"
       
11:00 - 再次触发 SELL @ 88800
       ⏰ 冷却期内，跳过（关键位已触发过）
```

---

## 🧪 测试验证

运行机器人后观察：

1. **相同周期一致性**
   - 1h 周期：同方向信号至少间隔2小时

2. **不同周期自适应**
   - 15m 周期：同方向信号至少间隔30分钟
   - 4h 周期：同方向信号至少间隔8小时

3. **关键位提醒**
   - 价格首次触达关键位时收到确认
   - 同一关键位不会重复提醒

---

## 🎉 升级优势总结

| 维度 | 旧机制 | 新机制 |
|:---|:---|:---|
| 冷却方式 | 固定分钟 | K线数量 |
| 周期一致性 | ❌ 不一致 | ✅ 完全一致 |
| 交易语义 | ❌ 物理时间 | ✅ 市场节奏 |
| 关键信息 | ❌ 可能漏掉 | ✅ 不会错过 |
| 刷屏控制 | ✅ 有效 | ✅ 更智能 |

---

## 🚀 现在可以运行了！

```bash
cd /Users/wang/PythonProjects/coin-singal-bot/macd_vol_signal_bot
python main.py
```

系统会自动：
- ✅ 按K线数量冷却（不同周期自适应）
- ✅ 在关键位置及时提醒
- ✅ 避免刷屏但不遗漏重要信息
- ✅ 像专业研究员一样理性工作

**这就是"加理性而不是加功能"的完美实现！** 🎯
